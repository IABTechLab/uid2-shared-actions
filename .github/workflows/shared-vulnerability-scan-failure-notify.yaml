name: Vulnerability Scan Failure Notification
on:
  workflow_call:
    inputs:
      failure_severity:
        description: The severity that will cause the action to fail if a vulnerability at that level is detected. UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
        default: CRITICAL,HIGH
        type: string
      publish_vulnerabilities:
        description: If true, will attempt to publish the results to the GitHub security tab
        default: 'false'
        type: string
      image_ref:
        description: The image reference to scan vulnerability on. If set it will be a image scan.
        default: ''
        type: string
      scan_type:
        description: The scan-type for aquasecurity/trivy-action action. Default to a fs scan.
        default: fs
        type: string
    secrets:
      SLACK_WEBHOOK:
        required: false

jobs:
  vulnerability_scan:
    runs-on:  ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Checkout uid2-shared-actions repo
        uses: actions/checkout@v4
        with:
          ref: v3
          repository: IABTechLab/uid2-shared-actions
          path: uid2-shared-actions

      - name: Vulnerability Scan
        id: vulnerability-scan
        uses: IABTechLab/uid2-shared-actions/actions/vulnerability_scan@v3
        with:
          scan_severity: HIGH,CRITICAL
          failure_severity: ${{ inputs.vulnerability_severity }}
          publish_vulnerabilities: ${{ inputs.publish_vulnerabilities }}
          image_ref: ${{ steps.extractImageTag.outputs.firstTag }}
          scan_type: ${{ inputs.scan_type }}
        continue-on-error: true

      - name: Check for vulnerability scan failure
        if: ${{ steps.vulnerability-scan.outcome == 'failure' }}
        env:
          SLACK_COLOR: danger
          SLACK_MESSAGE: 'The vulnerability scan has encountered a failure 1.'
          SLACK_TITLE: Vulnerability Scan Failure
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        uses: rtCamp/action-slack-notify@v2

      - name: fail the workflow if vulnerability scan fails
        if: ${{ steps.vulnerability-scan.outcome == 'failure' }}
        shell: bash
        run: |
          echo "Failing the workflow due to vulnerability scan failure"
          exit 1

