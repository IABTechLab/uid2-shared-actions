name: Vulnerability Scanning
description: Scans the file system for vulnerabilities
inputs:
  publish_vulnerabilities:
    description: 'If true, will attempt to publish the results to the GitHub security tab'
    required: false
    default: 'true'
runs:
  using: "composite"
  steps:
  - name: Generate Trivy vulnerability scan report
    uses: aquasecurity/trivy-action@0.14.0
    if: inputs.publish_vulnerabilities == 'true'
    with:
      scan-type: 'fs'
      format: 'sarif'
      exit-code: '0'
      ignore-unfixed: true
      severity: 'CRITICAL,HIGH'
      output: 'trivy-results.sarif'
      hide-progress: true

  - name: Upload Trivy scan report to GitHub Security tab
    uses: github/codeql-action/upload-sarif@v2
    if: inputs.publish_vulnerabilities == 'true'
    with:
      sarif_file: 'trivy-results.sarif'

  - name: Test with Trivy vulnerability scanner
    uses: aquasecurity/trivy-action@0.14.0
    with:
      scan-type: 'fs'
      format: 'table'
      exit-code: '1'
      ignore-unfixed: true
      severity: 'CRITICAL'
      hide-progress: true
