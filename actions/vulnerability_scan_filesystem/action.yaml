name: Vulnerability Scanning
description: Scans the file system for vulnerabilities
inputs:
  scan_severity:
    description: 'The severity that will cause the action to report if a vulnerability at that level is detected. UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
    required: false
    default: 'CRITICAL,HIGH'
  failure_severity:
    description: 'The severity that will cause the action to fail if a vulnerability at that level is detected. UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
    required: false
    default: 'CRITICAL'
  publish_vulnerabilities:
    description: 'If true, will attempt to publish the results to the GitHub security tab'
    required: false
    default: 'true'
runs:
  using: "composite"
  steps:
  - name: Checkout repo
    uses: actions/checkout@v3
    with:
      repository: IABTechLab/uid2-shared-actions
      ref: v2
      path: tmp-vulnerability-scan

  - name: Retrieve trivy-secret.yaml
    shell: bash
    run: |
      cp tmp-vulnerability-scan/trivy-secret.yaml ./trivy-secret.yaml
      rm -rf tmp-vulnerability-scan

  - name: Generate Trivy vulnerability scan report
    uses: aquasecurity/trivy-action@0.14.0
    if: inputs.publish_vulnerabilities == 'true'
    with:
      scan-type: 'fs'
      format: 'sarif'
      exit-code: '0'
      ignore-unfixed: true
      severity: ${{ inputs.scan_severity }}
      output: 'trivy-results.sarif'
      hide-progress: true

  - name: Upload Trivy scan report to GitHub Security tab
    uses: github/codeql-action/upload-sarif@v3
    if: inputs.publish_vulnerabilities == 'true'
    with:
      sarif_file: 'trivy-results.sarif'

  - name: Test with Trivy vulnerability scanner
    uses: aquasecurity/trivy-action@0.14.0
    with:
      scan-type: 'fs'
      format: 'table'
      exit-code: '1'
      ignore-unfixed: true
      severity: ${{ inputs.failure_severity }}
      hide-progress: true
